<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>寒假值日行事曆</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase SDK & App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    /**
     * ⚠️ 重要說明（避免 Firestore Runtime Error）
     * 1. 請務必填入正確的 Firebase 設定，否則 Firestore 會直接拋錯
     * 2. 所有 DOM 操作都放在 DOMContentLoaded 之後，避免抓到 null
     * 3. documentId 使用 YYYY-MM-DD（合法且穩定）
     */

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
    };

    document.addEventListener('DOMContentLoaded', () => {
      // ===== 基本防呆檢查 =====
      if (!firebaseConfig.apiKey || firebaseConfig.apiKey === 'YOUR_API_KEY') {
        alert('Firebase 尚未設定完成，請先填入 firebaseConfig');
        return;
      }

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const startDate = new Date('2025-01-26');
      const endDate = new Date('2025-02-22');

      const staffList = ['李通','婉惠','淑美','淑芬','怡芳','俊平','虹蓁'];
      const tbody = document.getElementById('calendar-body');
      const notifyEl = document.getElementById('notify');

      function formatDate(d) {
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`; // ✅ Firestore 合法 documentId
      }

      // ===== 簡單自我測試（避免隱性錯誤） =====
      console.assert(formatDate(new Date('2025-01-26')) === '2025-01-26', 'formatDate 測試失敗');

      function renderRow(date, data = {}) {
        const day = date.getDay();
        const isWeekend = day === 0 || day === 6;
        const id = formatDate(date);

        const tr = document.createElement('tr');
        if (isWeekend) tr.classList.add('weekend');

        tr.innerHTML = `
          <td>${id}<br>（星期${['日','一','二','三','四','五','六'][day]}）</td>
          <td><input class="task" value="${data.task || ''}" placeholder="輸入工作項目" /></td>
          <td>
            <select class="staff">
              <option value="">-- 請選擇 --</option>
              ${staffList.map(s => `<option value="${s}" ${data.staff === s ? 'selected' : ''}>${s}</option>`).join('')}
            </select>
          </td>
        `;

        const taskInput = tr.querySelector('.task');
        const staffSelect = tr.querySelector('.staff');

        const saveHandler = () => save(id, taskInput.value, staffSelect.value);
        taskInput.addEventListener('change', saveHandler);
        staffSelect.addEventListener('change', saveHandler);

        tbody.appendChild(tr);
      }

      async function save(id, task, staff) {
        try {
          await setDoc(doc(db, 'calendar', id), {
            task: task || '',
            staff: staff || ''
          }, { merge: true });
        } catch (err) {
          console.error('Firestore 寫入失敗', err);
          alert('資料儲存失敗，請確認 Firestore 權限設定');
        }
      }

      // ===== 即時同步 =====
      try {
        onSnapshot(collection(db, 'calendar'), snapshot => {
          tbody.innerHTML = '';
          const dataMap = {};
          snapshot.forEach(d => dataMap[d.id] = d.data());

          for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            renderRow(new Date(d), dataMap[formatDate(d)]);
          }

          notifyEl.classList.add('show');
          setTimeout(() => notifyEl.classList.remove('show'), 1500);
        });
      } catch (err) {
        console.error('Firestore 監聽失敗', err);
        alert('Firestore 即時同步初始化失敗，請檢查專案與安全規則');
      }
    });
  </script>

  <style>
    body {
      font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 20px;
    }
    h1 { text-align: center; margin-bottom: 16px; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 10px;
      text-align: center;
    }
    th { background: #f1f5f9; }
    tr.weekend { background: #fee2e2; }
    input, select { width: 95%; padding: 6px; }
    #notify {
      position: fixed;
      top: 12px;
      right: 12px;
      background: #2563eb;
      color: #fff;
      padding: 8px 14px;
      border-radius: 999px;
      opacity: 0;
      transition: .3s;
    }
    #notify.show { opacity: 1; }
  </style>
</head>
<body>
  <h1>寒假值日行事曆（即時同步）</h1>

  <table>
    <thead>
      <tr>
        <th>年月日（星期）</th>
        <th>工作項目</th>
        <th>值日人員</th>
      </tr>
    </thead>
    <tbody id="calendar-body"></tbody>
  </table>

  <div id="notify">資料已同步更新</div>
</body>
</html>
